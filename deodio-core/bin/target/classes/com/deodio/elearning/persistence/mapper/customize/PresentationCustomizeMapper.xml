<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.deodio.elearning.persistence.mapper.customize.PresentationCustomizeMapper">
  <resultMap id="BaseMediaResultMap" type="com.deodio.elearning.persistence.model.Media">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed May 11 10:03:53 CST 2016.
    -->
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="media_name" jdbcType="VARCHAR" property="mediaName" />
    <result column="media_desc" jdbcType="VARCHAR" property="mediaDesc" />
    <result column="media_size" jdbcType="BIGINT" property="mediaSize" />
    <result column="media_ext" jdbcType="VARCHAR" property="mediaExt" />
    <result column="media_url" jdbcType="VARCHAR" property="mediaUrl" />
    <result column="media_dir" jdbcType="VARCHAR" property="mediaDir" />
    <result column="media_length" jdbcType="BIGINT" property="mediaLength" />
    <result column="media_type" jdbcType="INTEGER" property="mediaType" />
    <result column="media_cover" jdbcType="VARCHAR" property="mediaCover" />
    <result column="media_width" jdbcType="INTEGER" property="mediaWidth" />
    <result column="media_height" jdbcType="INTEGER" property="mediaHeight" />
    <result column="create_id" jdbcType="VARCHAR" property="createId" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_id" jdbcType="VARCHAR" property="updateId" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="media_start" jdbcType="INTEGER" property="mediaStart" />
    <result column="media_end" jdbcType="BIGINT" property="mediaEnd" />
    <result column="account_id" jdbcType="VARCHAR" property="accountId" />
    <result column="media_original_name" jdbcType="VARCHAR" property="mediaOriginalName" />
  </resultMap>
  
  <resultMap id="BaseSlideResultMap" type="com.deodio.elearning.persistence.model.Slides">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri May 13 15:37:10 CST 2016.
    -->
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="slide_name" jdbcType="VARCHAR" property="slideName" />
    <result column="slide_size" jdbcType="BIGINT" property="slideSize" />
    <result column="slide_ext" jdbcType="VARCHAR" property="slideExt" />
    <result column="slide_url" jdbcType="VARCHAR" property="slideUrl" />
    <result column="slide_dir" jdbcType="VARCHAR" property="slideDir" />
    <result column="create_id" jdbcType="VARCHAR" property="createId" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_id" jdbcType="VARCHAR" property="updateId" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="account_id" jdbcType="VARCHAR" property="accountId" />
    <result column="slide_original_name" jdbcType="VARCHAR" property="slideOriginalName" />
  </resultMap>
	<!-- 设置Presentation信息 - 获取详细信息（关联查询图片路径） -->
	 <select id="getPresentationInfo" parameterType="java.util.Map"  resultType="java.util.Map">
		 SELECT
			pre. ID,
			pre.presentation_name,
			pre.presentation_desc,
			pre.presentation_model,
			pre.persentation_percentage,
			pre.is_pass_elements,
			pre.is_pass_quizs,
			pre.is_course,
			pre.is_pass_hours,
			pre.presentation_cover,
			pre.create_time,
			att.ID attachment_id,
			att.attach_dir,
			att.attach_url,
			att.rel_id,
			att.attach_name,
			att.attach_ext,
			att.attach_type,
			att.generate_name,
			(
				SELECT
					string_agg(tgs.tag_name,',')
				FROM
					t_tags tgs
				WHERE
					tgs. ID IN (
						SELECT
							tgsrel.tags_id
						FROM
							t_tags_presentation_rel tgsrel
						WHERE
							tgsrel.presentation_id = pre. ID
					)
			) tag_name
		FROM
			t_presentation pre
		LEFT JOIN t_attachment att on pre.id = att.rel_id
		where 1=1 
		<if test="presentationId != null">
			and pre. ID = #{presentationId,jdbcType=VARCHAR}
		</if>
	 </select>
	 
	 <!-- 标签List添加 -->
	 <insert id="insertPersentationTags" parameterType="java.util.List">
 		INSERT INTO t_tags (id,tag_name,tag_source,account_id,create_id,create_time)
	    VALUES 
	    <foreach collection="list" item="item"  separator="," >
	        (#{item.id},#{item.tagName},#{item.tagSource},#{item.accountId},#{item.createId},#{item.createTime})
	    </foreach>
	 </insert>
	 
	 <!-- 添加关联list -->
	 <insert id="insertPersentationTagsRel" parameterType="java.util.List">
 		INSERT INTO t_tags_presentation_rel (id,presentation_id,tags_id,create_id,create_time)
	    VALUES 
	    <foreach collection="list" item="item"  separator="," >
	        (#{item.id},#{item.presentationId},#{item.tagsId},#{item.createId},#{item.createTime})
	    </foreach>
	 </insert>
	 
	 <!-- 更新Tags标签库 (暂时未用到)-->
	 <update id="updatePersentationTags"  parameterType="java.util.List">
       <foreach collection="list" item="item" index="index" open="begin" close="end;" separator=";">
                update t_tags 
                <set>
                  tag_name = #{item.tagName},
                </set>
                <set>
                  tag_source = #{item.tagSource},
                </set>
                 <set>
                  account_id = #{item.accountId},
                </set>
                <set>
                  update_id = #{item.updateId},
                </set>
                <set>
                  update_time = #{item.updateTime},
                </set>
                where id = ${item.id}
       </foreach>
    </update>
    
    <!-- 删除tags标签库（暂时未用到） -->
    <delete id="deletePersentationTags" parameterType="String">
	 	delete from t_tags where id in 
	 	 (select rel.tags_id from t_tags_presentation_rel rel  where rel.presentation_id = #{presentationId})
 	</delete>
 	
 	<!-- 删除标签关联关系表 -->
 	<delete id="deletePersentationTagsRel" parameterType="String">
	 	delete from t_tags_presentation_rel rel where rel.presentation_id = #{presentationId} 
 	</delete>
 	
 	<update id="updatePresentationSyncMediaById" parameterType="com.deodio.elearning.persistence.model.PresentationSyncMedia">
    update t_presentation_sync_media
    <set>
      <if test="presentationId != null">
        presentation_id = #{presentationId,jdbcType=VARCHAR},
      </if>
      <if test="mediaId != null">
        media_id = #{mediaId,jdbcType=VARCHAR},
      </if>
      <if test="mediaName != null">
        media_name = #{mediaName,jdbcType=VARCHAR},
      </if>
      <if test="mediaSize != null">
        media_size = #{mediaSize,jdbcType=BIGINT},
      </if>
      <if test="mediaExt != null">
        media_ext = #{mediaExt,jdbcType=VARCHAR},
      </if>
      <if test="mediaUrl != null">
        media_url = #{mediaUrl,jdbcType=VARCHAR},
      </if>
      <if test="mediaDir != null">
        media_dir = #{mediaDir,jdbcType=VARCHAR},
      </if>
      <if test="mediaLength != null">
        media_length = #{mediaLength,jdbcType=BIGINT},
      </if>
      <if test="mediaType != null">
        media_type = #{mediaType,jdbcType=INTEGER},
      </if>
      <if test="mediaOrder != null">
        media_order = #{mediaOrder,jdbcType=INTEGER},
      </if>
      <if test="mediaCover != null">
        media_cover = #{mediaCover,jdbcType=VARCHAR},
      </if>
      <if test="mediaStart != null">
        media_start = #{mediaStart,jdbcType=BIGINT},
      </if>
      <if test="mediaEnd != null">
        media_end = #{mediaEnd,jdbcType=BIGINT},
      </if>
      <if test="mediaWidth != null">
        media_width = #{mediaWidth,jdbcType=INTEGER},
      </if>
      <if test="mediaHeight != null">
        media_height = #{mediaHeight,jdbcType=INTEGER},
      </if>
      <if test="createId != null">
        create_id = #{createId,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateId != null">
        update_id = #{updateId,jdbcType=VARCHAR},
      </if>
      <if test="updateTime != null">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
       <if test="mediaJobId != null">
        media_job_id = #{mediaJobId,jdbcType=VARCHAR},
      </if>
    </set>
    where presentation_id = #{presentationId,jdbcType=VARCHAR} and media_id = #{mediaId,jdbcType=VARCHAR}
  </update>
  
  <select id="findMediaInfoList" parameterType="java.util.Map"  resultMap="BaseMediaResultMap">
  	  select 
	  	  id, media_name, media_desc, 
	      media_size, media_ext, media_url, 
	      media_dir, media_length, media_type, 
	      media_cover, media_width, media_height, 
	      create_id, create_time, update_id, 
	      update_time, media_start, media_end, 
	      account_id, media_original_name
      from t_media
      where 1=1 
      <if test="accountId != null">
      	and account_id = #{accountId}
      </if>
      <if test="queryMediaInfo != null">
      	and media_original_name like CONCAT('%','${queryMediaInfo}','%' ) 
      </if>
      <if test="presentationId != null">
      	and id not in (select sync.media_id from t_presentation_sync_media sync where sync.presentation_id = #{presentationId}) 
      </if>
  </select>
  
  <select id="findSlideInfoList" parameterType="java.util.Map"  resultMap="BaseSlideResultMap">
  	  select 
	  	  id, slide_name, slide_size, 
      slide_ext, slide_url, slide_dir, 
      create_id, create_time, update_id, 
      update_time, account_id, slide_original_name
      from t_slides
      where 1=1 
      <if test="accountId != null">
      	and account_id = #{accountId}
      </if>
      <if test="querySlideInfo != null">
      	and slide_original_name like CONCAT('%','${querySlideInfo}','%' ) 
      </if>
      <if test="presentationId != null">
      	and id not in (select sync.slide_id from t_presentation_sync_slides sync where sync.presentation_id = #{presentationId}) 
      </if>
  </select>
  
  <select id="getMediaCount" parameterType="java.util.Map"  resultType="java.lang.Integer">
  	  select 
	  	  count(*)
      from t_media
      where 1=1 
      <if test="accountId != null">
      	and account_id = #{accountId}
      </if>
      <if test="queryMediaInfo != null">
      	and media_original_name like CONCAT('%','${queryMediaInfo}','%' ) 
      </if>
  </select>
  
  <select id="getSlideCount" parameterType="java.util.Map"  resultType="java.lang.Integer">
  	  select 
	  	  count(*)
      from t_slides
      where 1=1 
      <if test="accountId != null">
      	and account_id = #{accountId}
      </if>
      <if test="querySlideInfo != null">
      	and slide_original_name like CONCAT('%','${querySlideInfo}','%' ) 
      </if>
  </select>
  
  <!-- 系统多媒体保存 -->
  <select id="getMediaList" parameterType="java.util.List" resultType="java.util.Map">
 	 select 
	  	  id, media_name, media_desc, 
	      media_size, media_ext, media_url, 
	      media_dir, media_length, media_type, 
	      media_cover, media_width, media_height, 
	      create_id, create_time, update_id, 
	      update_time, media_start, media_end, 
	      account_id, media_original_name
      from t_media
      where id in<foreach collection="list" item="item" open="(" separator=","  close=")">
	        #{item.media_id}
	    </foreach>
  </select>
  
  <insert id="saveMediaList" parameterType="java.util.List">
 		INSERT INTO t_presentation_sync_media (
 			id, presentation_id, media_id, media_name, media_size, media_ext, media_url, media_dir, 
		    media_length, media_type, media_order, media_cover, media_start, media_end, media_width, 
		    media_height, create_id, create_time, media_original_name,media_convert_status
 		)
	    VALUES 
	    <foreach collection="list" item="item"  separator="," >
	        (#{item.id},#{item.presentation_id},#{item.media_id},#{item.media_name},#{item.media_size},
	        #{item.media_ext},#{item.media_url},#{item.media_dir},#{item.media_length},#{item.media_type},
	        #{item.media_order},#{item.media_cover},#{item.media_start},#{item.media_end},#{item.media_width},
	        #{item.media_height},#{item.create_id},#{item.create_time},#{item.media_original_name},#{item.media_convert_status}
	        )
	    </foreach>
	 </insert>
	 
	 <!-- PPT转换图片添加 -->
	 <insert id="insertSyncSlidesList" parameterType="java.util.List">
 		INSERT INTO t_presentation_sync_slides (id, presentation_id, slide_id, slide_name, slide_size, slide_ext, slide_url, slide_dir, 
    		slide_order, create_id, create_time, slide_original_name)
	    VALUES 
	    <foreach collection="list" item="item"  separator="," >
	        (#{item.id},#{item.presentationId},#{item.slideId},#{item.slideName},#{item.slideSize},#{item.slideExt},#{item.slideUrl},#{item.slideDir},
	        #{item.slideOrder},#{item.createId},#{item.createTime},#{item.slideOriginalName})
	    </foreach>
	 </insert>
	 
	 <!-- ppt反查询 -->
	 <select id="selectSyncSlidesList" parameterType="String"  resultMap="BaseSlideResultMap">
  	  select 
	  		id, slide_name, slide_size, slide_ext, slide_url, slide_dir, create_id, create_time, 
    		update_id, update_time, account_id, slide_original_name
      from t_slides
      where id in (
      	SELECT
			sync.slide_id
		FROM
			t_presentation_sync_slides sync
		WHERE
			(
				sync.presentation_id = #{presentationId}
			)
		GROUP BY
			sync.slide_id
	)
  </select>
  
  
  <!-- ppt和图片删除 -->
 	<delete id="delSyncSlide" parameterType="java.util.Map">
	 	delete from t_presentation_sync_slides  where slide_id = #{slideId} and presentation_id = #{presentationId}
 	</delete>
 	
 	<!-- 系统多媒体保存 查询保存的目标多媒体或PPT详细-->
  <select id="getSyncList" parameterType="java.util.List" resultType="java.util.Map">
 	 select 
  	  	id, slide_name, slide_size, slide_ext, slide_url, slide_dir, create_id, create_time, 
   		update_id, update_time, account_id, slide_original_name
      from t_slides
      where id in<foreach collection="list" item="item" open="(" separator=","  close=")">
	        #{item.id}
	    </foreach>
  </select>
  
  <!-- 多媒体库图片或者PPT保存 -->
  <insert id="saveSlideList" parameterType="java.util.List">
		INSERT INTO t_presentation_sync_slides (
			id, presentation_id, slide_id, slide_name, slide_size, slide_ext, slide_url, slide_dir, 
    		slide_order, create_id, create_time, slide_original_name
		)
    VALUES 
    <foreach collection="list" item="item"  separator="," >
        (#{item.id},#{item.presentation_id},#{item.slide_id},#{item.slide_name},#{item.slide_size},
        #{item.slide_ext},#{item.slide_url},#{item.slide_dir},#{item.slide_order},#{item.create_id},
        #{item.create_time},#{item.slide_original_name}
        )
    </foreach>
 </insert>
 
 <!-- <select id="getEditSlidesCount" parameterType="java.util.Map"  resultType="java.lang.Integer">
  	  select 
	  	  count(*)
      from t_presentation_sync_points
      where presentation_id = '${presentationId}'
      <if test="querySlidesInfo != null">
      	and media_original_name like CONCAT('%','${querySlidesInfo}','%' ) 
      </if>
  </select> -->
  
  <!-- 查询编辑Slides列表 -->
  <select id="getEditSlidesList" parameterType="java.util.Map"  resultType="java.util.Map">
  	  select 
	  	  points.id,points.presentation_id,points.sync_slide_id, 
      points.point_size,points.point_ext, points.point_url, 
      points.point_dir,points.point_time, points.point_order, 
      points.point_end, points.create_id, points.create_time,
      points.update_id,points.update_time,slides.slide_original_name
      from t_presentation_sync_points points left join t_slides slides on points.sync_slide_id = slides.id
      where presentation_id = '${presentationId}'
      <if test="querySlidesInfo != null and querySlidesInfo != ''">
      	and slides.slide_original_name like CONCAT('%','${querySlidesInfo}','%' ) 
      </if>
  </select>
  
  <!-- 查询编辑medias列表 -->
  <select id="getEditMediasList" parameterType="java.util.Map"  resultType="java.util.Map">
  	  select 
	  	  id, presentation_id, media_id, media_name, media_size, media_ext, media_url, media_dir, 
	    media_length, media_type, media_order, media_cover, media_start, media_end, media_width, 
	    media_height, create_id, create_time, update_id, update_time, media_original_name, 
	    media_convert_status, media_job_id
	  from t_presentation_sync_media
      where presentation_id = '${presentationId}'
      <if test="queryMediasInfo != null and queryMediasInfo != ''">
      	and media_original_name like CONCAT('%','${queryMediasInfo}','%' ) 
      </if>
  </select>
</mapper>